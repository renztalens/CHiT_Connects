name: Deploy to Cloud Run from Source

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: your-project-id
  SERVICE: your-service-name
  REGION: your-service-region

jobs:
  deploy:
    permissions:
      contents: 'read'
      id-token: 'write'

    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v0
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud config set project $PROJECT_ID
          gcloud config set run/region $REGION
          gcloud builds submit --tag gcr.io/$PROJECT_ID/$SERVICE .
          gcloud run deploy $SERVICE --image gcr.io/$PROJECT_ID/$SERVICE --platform managed --region $REGION --quiet --format json

      - name: Extract Service URL
        id: extract-url
        run: |
          echo "Deployment result:"
          echo "${{ steps.deploy.outputs.result }}"
          echo "::set-output name=url::$(echo '${{ steps.deploy.outputs.result }}' | jq -r '.status.url')"

      - name: Show Output
        run: echo "Deployed successfully to ${{ steps.extract-url.outputs.url }}"
